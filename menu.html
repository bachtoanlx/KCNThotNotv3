
<!-- Nh√∫ng CSS c·ªßa Bootstrap -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* ƒê·∫∑t ki·ªÉu m·∫∑c ƒë·ªãnh cho menu (·∫©n menu tr√™n m√†n h√¨nh nh·ªè) */
.menu {
    display: none; /* ·∫®n menu tr√™n m√†n h√¨nh nh·ªè */
    background-color: #333;
    padding: 10px;
}

.menu ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.menu ul li {
    margin: 10px 0;
}

.menu ul li a {
    color: white;
    text-decoration: none;
}

/* ƒê·ªãnh ki·ªÉu cho n√∫t menu */
.menu-toggle {
    display: none; /* ·∫®n n√∫t menu tr√™n m√†n h√¨nh l·ªõn */
    background-color: #333;
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
}

/* C√°c ki·ªÉu cho m√†n h√¨nh nh·ªè h∆°n 768px (ch·∫≥ng h·∫°n nh∆∞ di ƒë·ªông) */
@media (max-width: 768px) {
    .menu {
        display: block; /* Hi·ªÉn th·ªã menu tr√™n m√†n h√¨nh nh·ªè khi n√∫t menu ƒë∆∞·ª£c nh·∫•n */
    }

    .menu-toggle {
        display: block; /* Hi·ªÉn th·ªã n√∫t menu tr√™n m√†n h√¨nh nh·ªè */
    }

    .menu {
        display: none; /* Menu ·∫©n m·∫∑c ƒë·ªãnh tr√™n m√†n h√¨nh nh·ªè */
    }
}

/* C√°c ki·ªÉu cho m√†n h√¨nh l·ªõn h∆°n 768px (ch·∫≥ng h·∫°n nh∆∞ m√°y t√≠nh b·∫£ng ho·∫∑c m√°y t√≠nh ƒë·ªÉ b√†n) */
@media (min-width: 769px) {
    .menu {
        display: block; /* Hi·ªÉn th·ªã menu tr√™n m√†n h√¨nh l·ªõn */
    }

    .menu-toggle {
        display: none; /* ·∫®n n√∫t menu tr√™n m√†n h√¨nh l·ªõn */
    }
}


</style>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" id="navbarTitle" href="#">Gi·∫£i ph√°p c√¥ng ngh·ªá s·ªë</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Trang ch·ªß</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown1" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        D·ªØ li·ªáu
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="datatable.html">ƒê·ªìng h·ªì</a>
                        <a class="dropdown-item" href="datatable_2.html">Th√¥ng b√°o ngh·ªâ</a>
                        <a class="dropdown-item" href="datatable_3.html">ƒêi·ªán s·∫£n xu·∫•t</a>
                        <a class="dropdown-item" href="datatable_4.html">N∆∞·ªõc sinh ho·∫°t</a>
                        <a class="dropdown-item" href="datatable_5.html">ƒêi·ªán m·∫∑t tr·ªùi</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown2" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        B√°o c√°o
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="statistics.html">BC L∆∞u l∆∞·ª£ng</a>
                        <a class="dropdown-item" href="statistics_2.html">BC Ng√†y ngh·ªâ</a>
                        <a class="dropdown-item" href="statistics_3.html">BC ƒêi·ªán s·∫£n xu·∫•t</a>
                        <a class="dropdown-item" href="statistics_4.html">BC N∆∞·ªõc sinh ho·∫°t</a>
                        <a class="dropdown-item" href="statistics_5.html">BC ƒêi·ªán m·∫∑t tr·ªùi</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown3" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        T·∫°o Th√¥ng b√°o
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="notification.html">DN ng∆∞ng s·∫£n xu·∫•t</a>
                        <a class="dropdown-item" href="index.html">L∆∞u l∆∞·ª£ng ƒë·ªìng h·ªì</a>
                        <a class="dropdown-item" href="notification_2.html">S·∫£n l∆∞·ª£ng ƒêi·ªán s·∫£n xu·∫•t</a>
                        <a class="dropdown-item" href="notification_3.html">S·∫£n l∆∞·ª£ng N∆∞·ªõc sinh ho·∫°t</a>
                        <a class="dropdown-item" href="notification_4.html">S·∫£n l∆∞·ª£ng ƒêi·ªán m·∫∑t tr·ªùi</a>
                        <a class="dropdown-item" href="notification_5.html">Thu ph√≠ n∆∞·ªõc th·∫£i</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">Li√™n h·ªá</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item" id="loginLogoutButton">
                    <a class="nav-link" href="#" id="loginButton">ƒêƒÉng nh·∫≠p</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Modal Menu ƒêƒÉng nh·∫≠p -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">ƒêƒÉng nh·∫≠p</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="username">T√™n ƒëƒÉng nh·∫≠p:</label>
                        <input type="text" class="form-control" id="username" name="username" autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="password">M·∫≠t kh·∫©u:</label>
                        <input type="password" class="form-control" id="password" name="password" autocomplete="current-password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="loginSubmitButton">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS v√† jQuery (c·∫ßn thi·∫øt cho Bootstrap) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    // X·ª≠ l√Ω Menu -->
function toggleMenu() {
    var menu = document.querySelector('.menu');
    menu.style.display = (menu.style.display === 'block' || menu.style.display === '') ? 'none' : 'block';
}

// H√†m ƒë·ªÉ ƒë√≥ng menu
function closeMenu() {
    const navbarCollapse = document.getElementById('navbarNav');
    if (navbarCollapse && navbarCollapse.classList.contains('show')) {
        // N·∫øu menu ƒëang m·ªü, ƒë√≥ng n√≥
        const collapse = new bootstrap.Collapse(navbarCollapse, {
            toggle: false
        });
        collapse.hide();
    }
}



// üìå 1. ƒê·ªçc d·ªØ li·ªáu t·ª´ localStorage m·ªôt c√°ch an to√†n
function getSavedUser() {
    try {
        return {
            username: localStorage.getItem('loggedInUser'),
            role: localStorage.getItem('loggedInRole')
        };
    } catch (error) {
        console.warn("‚ö† Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ localStorage, th·ª≠ l·∫°i...");
        return null;
    }
}

// üìå 2. ·∫®n n·ªôi dung ngay khi trang t·∫£i l√™n nh∆∞ng kh√¥ng c·∫≠p nh·∫≠t UI v·ªôi
function initializePage(retry = false) {
    $('.protected-content').addClass('hidden-content');
    $('.admin-content').addClass('blur-content');

    var savedData = getSavedUser();

    if (savedData && savedData.username && savedData.role) {
        console.log("‚úÖ User t·ª´ localStorage:", savedData.username);
        updateUIForLoggedInUser(savedData.username, savedData.role);
    } else if (!retry) {
        setTimeout(() => initializePage(true), 1000); // üîÑ N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, th·ª≠ l·∫°i sau 1 gi√¢y
    } else {
        console.warn("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã modal");
        $('#loginModal').modal('show');
    }
}

// üìå 3. C·∫≠p nh·∫≠t UI khi user ƒëƒÉng nh·∫≠p
function updateUIForLoggedInUser(username, role) {
    if ($('#navbarTitle').text() !== `Xin ch√†o, ${username}`) { // üöÄ Ch·ªâ c·∫≠p nh·∫≠t n·∫øu kh√°c
        $('#navbarTitle').text('Xin ch√†o, ' + username);
        $('#loginButton').text('ƒêƒÉng xu·∫•t');
    }
    $('#loginModal').modal('hide'); // ‚úÖ ·∫®n modal khi ƒëƒÉng nh·∫≠p
    showProtectedContent(role);
}

// üìå 4. C·∫≠p nh·∫≠t UI khi user ƒëƒÉng xu·∫•t
function updateUIForLoggedOutUser() {
    $('#navbarTitle').text('Gi·∫£i ph√°p c√¥ng ngh·ªá s·ªë');
    $('#loginButton').text('ƒêƒÉng nh·∫≠p');
    hideProtectedContent();
    $('#loginModal').modal('show'); // ‚úÖ Hi·ªÉn th·ªã modal khi ƒëƒÉng xu·∫•t
}

// üìå 5. Ki·ªÉm tra t√†i kho·∫£n v·ªõi GAS nh∆∞ng CH·ªà khi t·∫£i trang
function checkLoginStatus(username) {
    console.log("üîç G·ª≠i y√™u c·∫ßu x√°c minh t√†i kho·∫£n l√™n GAS...");
    var url = `https://script.google.com/macros/s/AKfycbzg9lkoiVZeVE7kXcDV7gVa7lijeXjP-tAHukkv4lac5fXNzBJNOLYQEiSyu9cVgkmy/exec?username=${username}`;

    $.getJSON(url, function(response) {
        if (!response.success) {
            logoutUser(); // ‚ùå N·∫øu t√†i kho·∫£n kh√¥ng h·ª£p l·ªá, bu·ªôc ƒëƒÉng xu·∫•t
        } else {
            localStorage.setItem('loggedInRole', response.role);
        }
    }).fail(function() {
        console.warn("‚ö† Kh√¥ng th·ªÉ ki·ªÉm tra t√†i kho·∫£n, c√≥ th·ªÉ do l·ªói m·∫°ng.");
    });
}

// üìå 6. X·ª≠ l√Ω ƒëƒÉng nh·∫≠p khi ng∆∞·ªùi d√πng nh·∫≠p th√¥ng tin
$('#loginSubmitButton').click(function() {
    $('#loginModal').modal('hide');
    $('#loaderModal').modal('show');
    var username = $('#username').val();
    var password = $('#password').val();
    var url = "https://script.google.com/macros/s/AKfycbzg9lkoiVZeVE7kXcDV7gVa7lijeXjP-tAHukkv4lac5fXNzBJNOLYQEiSyu9cVgkmy/exec";

    $.getJSON(url, { username: username, password: password }, function(response) {
        if (response.success) {
            localStorage.setItem("loggedInUser", username);
            localStorage.setItem("loggedInRole", response.role);
            
            updateUIForLoggedInUser(username, response.role);
            
            $('#loaderModal').modal('hide');
            toastr.success("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "Th√†nh c√¥ng");
        } else {
            toastr.error("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!", "L·ªói");
        }
    }).fail(function() {
        toastr.error("L·ªói k·∫øt n·ªëi ƒë·∫øn server!", "L·ªói");
    });
});

// üìå 7. X·ª≠ l√Ω ƒëƒÉng xu·∫•t khi ng∆∞·ªùi d√πng nh·∫•n n√∫t
$('#loginButton').click(function() {
    if ($(this).text() === "ƒêƒÉng xu·∫•t") {
        logoutUser();
    } else {
        $('#loginModal').modal('show');
    }
});

// üìå 8. ƒêƒÉng xu·∫•t v√† c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
function logoutUser() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedInRole");

    updateUIForLoggedOutUser();
    toastr.success("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!", "ƒêƒÉng xu·∫•t");
}

// üìå 9. ·∫®n n·ªôi dung b·∫£o v·ªá khi ƒëƒÉng xu·∫•t
function hideProtectedContent() {
    $('.protected-content').addClass('hidden-content');
    $('.admin-content').addClass('blur-content');
}

// üìå 10. Hi·ªÉn th·ªã n·ªôi dung b·∫£o v·ªá theo quy·ªÅn
function showProtectedContent(role) {
    $('.protected-content').removeClass('hidden-content');

    if (role === 'admin') {
        $('.admin-content').removeClass('blur-content');
    } else {
        $('.admin-content').addClass('blur-content');
    }
}

// üìå 11. Khi trang t·∫£i l√™n, ƒë·∫£m b·∫£o ki·ªÉm tra t√†i kho·∫£n ƒë√∫ng c√°ch
$(document).ready(function() {
    initializePage();
    var savedUser = localStorage.getItem('loggedInUser');
    if (savedUser) {
        setTimeout(() => checkLoginStatus(savedUser), 6000); // üöÄ Ki·ªÉm tra GAS sau 06 gi√¢y ƒë·ªÉ tr√°nh ch·∫≠m UI
    }
});


</script>
