
<!-- Nhúng CSS của Bootstrap -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* Đặt kiểu mặc định cho menu (ẩn menu trên màn hình nhỏ) */
.menu {
    display: none; /* Ẩn menu trên màn hình nhỏ */
    background-color: #333;
    padding: 10px;
}

.menu ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.menu ul li {
    margin: 10px 0;
}

.menu ul li a {
    color: white;
    text-decoration: none;
}

/* Định kiểu cho nút menu */
.menu-toggle {
    display: none; /* Ẩn nút menu trên màn hình lớn */
    background-color: #333;
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
}

/* Các kiểu cho màn hình nhỏ hơn 768px (chẳng hạn như di động) */
@media (max-width: 768px) {
    .menu {
        display: block; /* Hiển thị menu trên màn hình nhỏ khi nút menu được nhấn */
    }

    .menu-toggle {
        display: block; /* Hiển thị nút menu trên màn hình nhỏ */
    }

    .menu {
        display: none; /* Menu ẩn mặc định trên màn hình nhỏ */
    }
}

/* Các kiểu cho màn hình lớn hơn 768px (chẳng hạn như máy tính bảng hoặc máy tính để bàn) */
@media (min-width: 769px) {
    .menu {
        display: block; /* Hiển thị menu trên màn hình lớn */
    }

    .menu-toggle {
        display: none; /* Ẩn nút menu trên màn hình lớn */
    }
}


</style>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" id="navbarTitle" href="#">Giải pháp công nghệ số</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Trang chủ</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown1" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dữ liệu
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="datatable.html">Đồng hồ</a>
                        <a class="dropdown-item" href="datatable_2.html">Thông báo nghỉ</a>
                        <a class="dropdown-item" href="datatable_3.html">Điện sản xuất</a>
                        <a class="dropdown-item" href="datatable_4.html">Nước sinh hoạt</a>
                        <a class="dropdown-item" href="datatable_5.html">Điện mặt trời</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown2" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Báo cáo
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="statistics.html">BC Lưu lượng</a>
                        <a class="dropdown-item" href="statistics_2.html">BC Ngày nghỉ</a>
                        <a class="dropdown-item" href="statistics_3.html">BC Điện sản xuất</a>
                        <a class="dropdown-item" href="statistics_4.html">BC Nước sinh hoạt</a>
                        <a class="dropdown-item" href="statistics_5.html">BC Điện mặt trời</a>
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown3" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Tạo Thông báo
                    </a>
                    <div class="dropdown-menu" aria-labelledby="statisticsDropdown">
                        <a class="dropdown-item" href="notification.html">DN ngưng sản xuất</a>
                        <a class="dropdown-item" href="index.html">Lưu lượng đồng hồ</a>
                        <a class="dropdown-item" href="notification_2.html">Sản lượng Điện sản xuất</a>
                        <a class="dropdown-item" href="notification_3.html">Sản lượng Nước sinh hoạt</a>
                        <a class="dropdown-item" href="notification_4.html">Sản lượng Điện mặt trời</a>
                        <a class="dropdown-item" href="notification_5.html">Thu phí nước thải</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">Liên hệ</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item" id="loginLogoutButton">
                    <a class="nav-link" href="#" id="loginButton">Đăng nhập</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Modal Menu Đăng nhập -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Đăng nhập</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label for="username">Tên đăng nhập:</label>
                        <input type="text" class="form-control" id="username" name="username" autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="password">Mật khẩu:</label>
                        <input type="password" class="form-control" id="password" name="password" autocomplete="current-password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="loginSubmitButton">Đăng nhập</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS và jQuery (cần thiết cho Bootstrap) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    // Xử lý Menu -->
function toggleMenu() {
    var menu = document.querySelector('.menu');
    menu.style.display = (menu.style.display === 'block' || menu.style.display === '') ? 'none' : 'block';
}

// Hàm để đóng menu
function closeMenu() {
    const navbarCollapse = document.getElementById('navbarNav');
    if (navbarCollapse && navbarCollapse.classList.contains('show')) {
        // Nếu menu đang mở, đóng nó
        const collapse = new bootstrap.Collapse(navbarCollapse, {
            toggle: false
        });
        collapse.hide();
    }
}



// 📌 1. Ẩn nội dung ngay khi trang tải lên (giữ UI ổn định)
function initializePage() {
    $('.protected-content').addClass('hidden-content');
    $('.admin-content').addClass('blur-content');
    
    var savedUser = localStorage.getItem('loggedInUser');
    var savedRole = localStorage.getItem('loggedInRole');
    

    // ✅ Nếu đã đăng nhập trước đó, hiển thị lời chào ngay lập tức
    if (savedUser && savedRole) {
        updateUIForLoggedInUser(savedUser, savedRole);
    } else {
        $('#loginModal').modal('show'); // ✅ Hiển thị modal nếu chưa đăng nhập
    }
}

// 📌 2. Cập nhật UI khi user đăng nhập
function updateUIForLoggedInUser(username, role) {
    $('#loginModal').modal('hide');
    $('#navbarTitle').text('Xin chào, ' + username);
    $('#loginButton').text('Đăng xuất');
    $('#loginModal').modal('hide'); // ✅ Đảm bảo modal bị ẩn nếu đã đăng nhập
    showProtectedContent(role); // Hiển thị nội dung theo quyền
}

// 📌 3. Cập nhật UI khi user đăng xuất
function updateUIForLoggedOutUser() {
    $('#navbarTitle').text('Giải pháp công nghệ số'); // ✅ Không cập nhật nếu trang đang tải
    $('#loginButton').text('Đăng nhập');
    hideProtectedContent();
    $('#loginModal').modal('show'); // ✅ Hiển thị modal khi đăng xuất
}

// 📌 4. Kiểm tra đăng nhập từ `localStorage` hoặc GAS (chỉ sau 30 phút)
function checkLoginStatus(username) {
    const lastCheck = localStorage.getItem('lastLoginCheck');
    const now = Date.now();
    const thirtyMinutes = 30 * 60 * 1000; // 30 phút

    if (lastCheck && (now - parseInt(lastCheck) < thirtyMinutes)) {
        console.log("⏳ Đã kiểm tra gần đây, không gọi API GAS.");
        return;
    }

    console.log("🔍 Kiểm tra đăng nhập với GAS...");
    var url = `https://script.google.com/macros/s/AKfycbzg9lkoiVZeVE7kXcDV7gVa7lijeXjP-tAHukkv4lac5fXNzBJNOLYQEiSyu9cVgkmy/exec?username=${username}`;

    $.getJSON(url, function(response) {
        if (response.success) {
            localStorage.setItem('lastLoginCheck', now);
            localStorage.setItem('loggedInRole', response.role);
        } else {
            logoutUser();
        }
    }).fail(function() {
        console.warn("Không thể kiểm tra tài khoản, có thể do lỗi mạng.");
    });
}

// 📌 5. Xử lý đăng nhập khi người dùng nhập thông tin
$('#loginSubmitButton').click(function() {
    $('#loginModal').modal('hide');
    $('#loaderModal').modal('show');
    var username = $('#username').val();
    var password = $('#password').val();
    var url = "https://script.google.com/macros/s/AKfycbzg9lkoiVZeVE7kXcDV7gVa7lijeXjP-tAHukkv4lac5fXNzBJNOLYQEiSyu9cVgkmy/exec";

    $.getJSON(url, { username: username, password: password }, function(response) {
        if (response.success) {
            localStorage.setItem("loggedInUser", username);
            localStorage.setItem("lastLoginCheck", Date.now());
            localStorage.setItem("loggedInRole", response.role);
            
            updateUIForLoggedInUser(username, response.role);
            
            $('#loaderModal').modal('hide');
            toastr.success("Đăng nhập thành công!", "Thành công");
        } else {
            toastr.error("Tên đăng nhập hoặc mật khẩu không chính xác!", "Lỗi");
        }
    }).fail(function() {
        toastr.error("Lỗi kết nối đến server!", "Lỗi");
    });
});

// 📌 6. Xử lý đăng xuất khi người dùng nhấn nút
$('#loginButton').click(function() {
    if ($(this).text() === "Đăng xuất") {
        logoutUser();
    } else {
        $('#loginModal').modal('show');
    }
});

// 📌 7. Đăng xuất và cập nhật UI ngay lập tức
function logoutUser() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("lastLoginCheck");
    localStorage.removeItem("loggedInRole");

    updateUIForLoggedOutUser();
    toastr.success("Bạn đã đăng xuất thành công!", "Đăng xuất");
 
}

// 📌 8. Ẩn nội dung bảo vệ khi đăng xuất
function hideProtectedContent() {
    $('.protected-content').addClass('hidden-content');
    $('.admin-content').addClass('blur-content');
}

// 📌 9. Hiển thị nội dung bảo vệ theo quyền
function showProtectedContent(role) {
    $('.protected-content').removeClass('hidden-content');

    if (role === 'admin') {
        $('.admin-content').removeClass('blur-content');
    } else {
        $('.admin-content').addClass('blur-content');
    }
}

// 📌 10. Khi trang tải lên, kiểm tra trạng thái đăng nhập
$(document).ready(function() {
    initializePage();
    var savedUser = localStorage.getItem('loggedInUser');
    if (savedUser) {
        checkLoginStatus(savedUser);
    }
});





</script>